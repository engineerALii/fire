<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAOS Gallery</title>
    
    <!-- الخطوط -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- أيقونات Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #0f172a;
            color: white;
            overflow-x: hidden;
        }

        /* تأثير الزجاج */
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        /* نافذة المودال الزجاجية */
        .glass-modal {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* كرات الخلفية المتحركة */
        .orb {
            position: fixed;
            border-radius: 50%;
            filter: blur(80px);
            z-index: -1;
            animation: float 10s infinite ease-in-out;
        }
        
        @keyframes float {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(20px, -20px); }
        }

        /* Masonry Layout fallback */
        .masonry-grid {
            column-count: 1;
            column-gap: 2rem;
        }
        @media (min-width: 768px) {
            .masonry-grid { column-count: 2; }
        }
        @media (min-width: 1024px) {
            .masonry-grid { column-count: 3; }
        }
        
        .masonry-item {
            break-inside: avoid;
            margin-bottom: 2rem;
        }

        /* تخصيص شريط التمرير */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a; 
        }
        ::-webkit-scrollbar-thumb {
            background: #334155; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569; 
        }
        
        /* تأثيرات الأزرار */
        .admin-btn {
            transform: scale(0.9);
            transition: all 0.2s;
        }
        .admin-btn:hover {
            transform: scale(1);
        }

        /* تخصيص Select */
        select option {
            background-color: #1e293b;
            color: white;
        }
    </style>
</head>
<body class="min-h-screen relative">

    <!-- خلفية متحركة -->
    <div class="orb w-[40vw] h-[40vw] bg-purple-600/30 top-[-10%] left-[-10%]"></div>
    <div class="orb w-[40vw] h-[40vw] bg-blue-600/20 bottom-[-10%] right-[-10%] animation-delay-2000"></div>
    <div class="orb w-[30vw] h-[30vw] bg-pink-600/20 top-[40%] left-[40%] animation-delay-4000"></div>

    <!-- نافذة كلمة المرور (Modal) -->
    <div id="password-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="glass-modal p-8 rounded-2xl w-full max-w-md mx-4 transform scale-95 transition-transform duration-300 shadow-2xl relative">
            <button id="close-password-modal" class="absolute top-4 left-4 text-gray-400 hover:text-white transition-colors">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-blue-500/20 rounded-full flex items-center justify-center mx-auto mb-4 border border-blue-500/30">
                    <i data-lucide="shield-check" class="w-8 h-8 text-blue-400"></i>
                </div>
                <h2 class="text-2xl font-bold text-white mb-2">منطقة المشرف</h2>
                <p class="text-gray-400 text-sm">الرجاء إدخال كلمة المرور للوصول إلى لوحة التحكم</p>
            </div>

            <form id="password-form" class="space-y-4">
                <div class="relative">
                    <input type="password" id="admin-password" placeholder="كلمة المرور..." 
                        class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-blue-500/50 focus:bg-white/10 transition-all text-center tracking-widest">
                </div>
                <div id="password-error" class="text-red-400 text-xs text-center h-4 hidden">كلمة المرور غير صحيحة</div>
                <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-bold py-3 rounded-xl transition-all shadow-lg shadow-blue-500/20 transform hover:-translate-y-0.5">
                    تأكيد الدخول
                </button>
            </form>
        </div>
    </div>

    <!-- نافذة إدخال تفاصيل الصورة (Modal) -->
    <div id="title-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="glass-modal p-8 rounded-2xl w-full max-w-md mx-4 transform scale-95 transition-transform duration-300 shadow-2xl relative">
            <button id="close-title-modal" class="absolute top-4 left-4 text-gray-400 hover:text-white transition-colors">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-pink-500/20 rounded-full flex items-center justify-center mx-auto mb-4 border border-pink-500/30">
                    <i data-lucide="image-plus" class="w-8 h-8 text-pink-400"></i>
                </div>
                <h2 class="text-2xl font-bold text-white mb-2">تفاصيل العمل الفني</h2>
                <p class="text-gray-400 text-sm">أضف عنواناً وتصنيفاً لصورتك</p>
            </div>

            <form id="title-form" class="space-y-4">
                <div class="space-y-2">
                    <label class="text-sm text-gray-300">عنوان الصورة</label>
                    <input type="text" id="image-title-input" placeholder="مثال: مخطوطة الكوفة" 
                        class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-pink-500/50 focus:bg-white/10 transition-all text-right" required>
                </div>
                
                <div class="space-y-2">
                    <label class="text-sm text-gray-300">نوع الصورة (التصنيف)</label>
                    <div class="relative">
                        <select id="image-category-input" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-pink-500/50 focus:bg-white/10 transition-all appearance-none cursor-pointer">
                            <option value="كاليغرافي">كاليغرافي</option>
                            <option value="بورتريه">بورتريه</option>
                            <option value="خرائط">خرائط</option>
                            <option value="المجتمع">المجتمع</option>
                        </select>
                        <i data-lucide="chevron-down" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none"></i>
                    </div>
                </div>

                <button type="submit" class="w-full bg-gradient-to-r from-pink-600 to-rose-600 hover:from-pink-500 hover:to-rose-500 text-white font-bold py-3 rounded-xl transition-all shadow-lg shadow-pink-500/20 transform hover:-translate-y-0.5 mt-4">
                    نشر العمل
                </button>
            </form>
        </div>
    </div>

    <!-- القائمة العلوية -->
    <nav class="fixed top-0 left-0 right-0 z-50 px-4 py-4">
        <div class="glass-card max-w-7xl mx-auto px-6 py-3 flex justify-between items-center rounded-full">
            <!-- الشعار والحالة -->
            <div class="flex items-center gap-4">
                <div class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-300 via-purple-300 to-indigo-300 font-sans tracking-wide">
                    TAOS
                </div>
                <!-- حالة الاتصال (مخفي افتراضياً) -->
                <div id="connection-status" class="hidden items-center gap-1 bg-amber-500/10 border border-amber-500/20 px-2 py-0.5 rounded-full">
                    <i data-lucide="wifi-off" class="w-3 h-3 text-amber-400"></i>
                    <span class="text-[10px] text-amber-200 font-bold">جاري الاتصال...</span>
                </div>
            </div>

            <!-- روابط سطح المكتب -->
            <div class="hidden md:flex items-center gap-8">
                <a href="#" class="text-gray-200 hover:text-white font-medium transition-colors">الرئيسية</a>
                <a href="#" class="text-gray-200 hover:text-white font-medium transition-colors">المعرض</a>
                <!-- زر المشرف -->
                <button id="admin-toggle-btn" class="text-gray-400 hover:text-white transition-colors p-2 rounded-full hover:bg-white/5" title="دخول المشرف">
                    <i data-lucide="lock" class="w-4 h-4"></i>
                </button>
            </div>

            <!-- الإجراءات -->
            <div class="flex items-center gap-4">
                <input type="file" id="file-upload" class="hidden" accept="image/*">
                
                <!-- زر الرفع (يظهر فقط للمشرف) -->
                <button id="upload-btn" class="hidden flex items-center gap-2 bg-pink-500/20 hover:bg-pink-500/40 text-pink-100 px-5 py-2 rounded-full text-sm font-bold transition-all border border-pink-500/30">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    <span id="upload-text">نشر صورة</span>
                </button>

                <!-- حقل البحث -->
                <div class="hidden md:block relative group">
                    <input type="text" id="search-input" placeholder="بحث..." class="bg-white/5 border border-white/10 rounded-full px-4 py-1.5 text-sm text-white focus:outline-none focus:bg-white/10 focus:border-white/30 transition-all w-32 group-hover:w-48 placeholder-gray-400">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4"></i>
                </div>
            </div>
        </div>
    </nav>

    <!-- المحتوى الرئيسي -->
    <main class="pt-32 pb-12 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto">
        
        <!-- رسائل الخطأ -->
        <div id="error-banner" class="hidden mb-8 bg-amber-500/20 border border-amber-500/50 text-amber-100 p-4 rounded-xl flex items-center justify-between backdrop-blur-md animate-bounce">
            <div class="flex items-center gap-3">
                <i data-lucide="alert-triangle" class="text-amber-400"></i>
                <span id="error-text" class="text-sm font-bold"></span>
            </div>
             <a id="error-action-link" href="#" target="_blank" class="text-xs bg-amber-500/30 hover:bg-amber-500/50 px-3 py-1 rounded-full transition-colors hidden">
                انقر هنا للإصلاح
            </a>
        </div>

        <!-- حالة المشرف -->
        <div id="admin-badge" class="hidden text-center mb-4">
            <span class="bg-red-500/20 text-red-200 border border-red-500/30 px-3 py-1 rounded-full text-xs font-bold animate-pulse">
                <i data-lucide="shield" class="w-3 h-3 inline-block ml-1"></i>
                وضع المشرف مفعل
            </span>
        </div>

        <!-- الترويسة -->
        <div class="text-center mb-16">
            <h1 class="text-5xl md:text-7xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-200 via-pink-200 to-white mb-6 drop-shadow-lg font-sans">
                TAOS
            </h1>
            <p class="text-xl text-gray-300 max-w-2xl mx-auto leading-relaxed mb-8">
                وجهتك الأولى لطلب اللوحات الفنية المصممة خصيصاً لك. نحول أفكارك إلى أعمال فنية ملموسة تضفي لمسة من الجمال والأناقة على مساحتك الخاصة.
            </p>
            
            <!-- زر الطلب من الانستغرام -->
            <a href="https://instagram.com/taos.iraq" target="_blank" class="inline-flex items-center gap-2 bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-500 hover:to-purple-500 text-white font-bold py-3 px-8 rounded-full transition-all shadow-lg hover:shadow-pink-500/30 transform hover:-translate-y-1 mb-10">
                <i data-lucide="instagram" class="w-5 h-5"></i>
                <span>اطلب لوحتك الآن</span>
            </a>
            
            <!-- التصنيفات -->
            <div id="filters" class="flex flex-wrap justify-center gap-3 mt-4">
                <!-- سيتم توليد الأزرار بواسطة JS -->
            </div>
        </div>

        <!-- حالة التحميل -->
        <div id="loading-indicator" class="hidden max-w-md mx-auto mb-8 bg-blue-500/20 border border-blue-500/50 rounded-xl p-4 flex items-center justify-center gap-3 text-blue-100 animate-pulse">
            <i data-lucide="loader" class="animate-spin"></i>
            <span>جاري معالجة ورفع الصورة (يرجى الانتظار)...</span>
        </div>

        <!-- شبكة الصور -->
        <div id="gallery-grid" class="masonry-grid min-h-[200px]">
            <!-- سيتم إضافة الصور هنا -->
        </div>

        <!-- رسالة فارغة -->
        <div id="empty-state" class="hidden text-center py-20 text-gray-400">
            <i data-lucide="image" class="w-16 h-16 mx-auto mb-4 opacity-50"></i>
            <p class="text-xl">لا توجد صور لعرضها حالياً</p>
        </div>

    </main>

    <footer class="text-center py-8 text-gray-500 text-sm border-t border-white/5 relative z-10 glass-card mx-4 rounded-t-2xl">
        <p>© 2025 TAOS Gallery. جميع الحقوق محفوظة.</p>
    </footer>

    <!-- Firebase Script Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, deleteDoc, doc, increment } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- إعدادات Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyD6MRZ7d7J1333erYoBrUGqocJNdGNjB7w",
            authDomain: "neew-aec2b.firebaseapp.com",
            databaseURL: "https://neew-aec2b-default-rtdb.firebaseio.com",
            projectId: "neew-aec2b",
            storageBucket: "neew-aec2b.firebasestorage.app",
            messagingSenderId: "70112873200",
            appId: "1:70112873200:web:b8ef2b3863be6f1bf39035"
        };

        // تهيئة Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- الحالة (State) ---
        let state = {
            user: null,
            dbPosts: [],
            localPosts: [],
            filter: 'الكل',
            searchQuery: '', // إضافة خاصية البحث
            isUploading: false,
            isConnected: false,
            isAdmin: false,
            pendingFile: null
        };

        // --- البيانات الثابتة ---
        const initialPostsData = [];

        // --- عناصر DOM ---
        const galleryGrid = document.getElementById('gallery-grid');
        const filtersContainer = document.getElementById('filters');
        const uploadBtn = document.getElementById('upload-btn');
        const fileInput = document.getElementById('file-upload');
        const searchInput = document.getElementById('search-input'); // عنصر البحث
        const loadingIndicator = document.getElementById('loading-indicator');
        const emptyState = document.getElementById('empty-state');
        const statusDiv = document.getElementById('connection-status');
        const errorBanner = document.getElementById('error-banner');
        const errorText = document.getElementById('error-text');
        const errorActionLink = document.getElementById('error-action-link');
        const adminToggleBtn = document.getElementById('admin-toggle-btn');
        const adminBadge = document.getElementById('admin-badge');
        
        // عناصر مودال كلمة المرور
        const passwordModal = document.getElementById('password-modal');
        const passwordForm = document.getElementById('password-form');
        const passwordInput = document.getElementById('admin-password');
        const passwordError = document.getElementById('password-error');
        const closePasswordModalBtn = document.getElementById('close-password-modal');

        // عناصر مودال العنوان والتصنيف
        const titleModal = document.getElementById('title-modal');
        const titleForm = document.getElementById('title-form');
        const titleInput = document.getElementById('image-title-input');
        const categoryInput = document.getElementById('image-category-input');
        const closeTitleModalBtn = document.getElementById('close-title-modal');

        // --- تفعيل البحث ---
        if(searchInput) {
            searchInput.addEventListener('input', (e) => {
                state.searchQuery = e.target.value.toLowerCase();
                renderGallery();
            });
        }

        // --- إدارة المشاركة (Share) ---
        window.handleShare = async (title, category) => {
            const shareData = {
                title: 'TAOS Gallery - ' + title,
                text: `شاهد هذا العمل الفني الرائع "${title}" في قسم ${category} على معرض TAOS`,
                url: window.location.href
            };

            if (navigator.share) {
                try {
                    await navigator.share(shareData);
                } catch (err) {
                    console.log('Error sharing:', err);
                }
            } else {
                try {
                    await navigator.clipboard.writeText(`${shareData.text}\n${shareData.url}`);
                    alert(`تم نسخ رابط المشاركة للعمل: "${title}"`);
                } catch (err) {
                    alert('المتصفح لا يدعم المشاركة التلقائية.');
                }
            }
        };

        // --- دوال مساعدة للنوافذ المنبثقة ---
        const openModal = (modalElement) => {
            modalElement.classList.remove('hidden');
            setTimeout(() => {
                modalElement.classList.remove('opacity-0');
                const content = modalElement.querySelector('div');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);
            const input = modalElement.querySelector('input');
            if(input) {
                input.value = '';
                input.focus();
            }
        };

        const closeModal = (modalElement) => {
            modalElement.classList.add('opacity-0');
            const content = modalElement.querySelector('div');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            setTimeout(() => {
                modalElement.classList.add('hidden');
            }, 300);
        };

        // --- إدارة المشرف ---
        const handleAdminToggle = () => {
            if (state.isAdmin) {
                state.isAdmin = false;
                alert("تم الخروج من وضع المشرف");
                updateAdminUI();
                renderGallery();
            } else {
                passwordError.classList.add('hidden'); // إخفاء خطأ سابق
                openModal(passwordModal);
            }
        };

        passwordForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const password = passwordInput.value;
            
            if (password === "alikuka2002alikuka") {
                state.isAdmin = true;
                updateAdminUI();
                renderGallery();
                closeModal(passwordModal);
            } else {
                passwordError.classList.remove('hidden');
                passwordInput.classList.add('border-red-500');
                passwordInput.classList.add('animate-pulse');
                setTimeout(() => passwordInput.classList.remove('animate-pulse'), 500);
            }
        });

        closePasswordModalBtn.addEventListener('click', () => closeModal(passwordModal));
        
        if(adminToggleBtn) {
            adminToggleBtn.addEventListener('click', handleAdminToggle);
        }

        // --- إدارة إدخال العنوان والتصنيف ---
        closeTitleModalBtn.addEventListener('click', () => {
            closeModal(titleModal);
            state.pendingFile = null; // إلغاء الرفع
            fileInput.value = ''; // تصفية الإدخال
        });

        titleForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = titleInput.value || "بدون عنوان";
            const category = categoryInput.value || "المجتمع"; // الحصول على التصنيف
            closeModal(titleModal);
            
            if (state.pendingFile) {
                await processUpload(state.pendingFile, title, category);
                state.pendingFile = null;
                fileInput.value = '';
            }
        });

        function updateAdminUI() {
            updateStatusUI(); // تحديث حالة الاتصال أيضاً
            if (state.isAdmin) {
                uploadBtn.classList.remove('hidden');
                adminBadge.classList.remove('hidden');
                adminToggleBtn.innerHTML = '<i data-lucide="unlock" class="w-4 h-4 text-green-400"></i>';
                adminToggleBtn.classList.add('bg-white/10');
            } else {
                uploadBtn.classList.add('hidden');
                adminBadge.classList.add('hidden');
                adminToggleBtn.innerHTML = '<i data-lucide="lock" class="w-4 h-4"></i>';
                adminToggleBtn.classList.remove('bg-white/10');
            }
            lucide.createIcons();
        }

        // --- تهيئة المصادقة ---
        async function initAuth() {
            try {
                await signInAnonymously(auth);
            } catch (err) {
                console.error("Auth Error:", err);
                if (err.code === 'auth/admin-restricted-operation') {
                    showError("الرجاء تفعيل 'Anonymous' في Firebase Authentication", "https://console.firebase.google.com/project/neew-aec2b/authentication/providers");
                }
            }
        }

        onAuthStateChanged(auth, (user) => {
            state.user = user;
            state.isConnected = !!user;
            updateStatusUI();
            if (user) setupRealtimeListener();
        });

        // --- الاستماع للبيانات ---
        function setupRealtimeListener() {
            const postsRef = collection(db, 'gallery_posts');
            onSnapshot(postsRef, (snapshot) => {
                const fetchedPosts = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    isStatic: false
                }));
                fetchedPosts.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                state.dbPosts = fetchedPosts;
                
                errorBanner.classList.add('hidden');
                renderGallery();
            }, (error) => {
                console.log("Firestore error:", error);
                if (error.message.includes("does not exist") || error.code === 'not-found') {
                    showError("قاعدة البيانات غير موجودة! أنشئها في Firebase Console", "https://console.firebase.google.com/project/neew-aec2b/firestore");
                } else if (error.code === 'permission-denied') {
                    showError("صلاحيات الوصول مرفوضة. يرجى تعديل Rules.", "https://console.firebase.google.com/project/neew-aec2b/firestore/rules");
                }
            });
        }

        // --- ضغط الصور ---
        function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 700;
                        const MAX_HEIGHT = 700;
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_HEIGHT) {
                                width *= MAX_HEIGHT / height;
                                height = MAX_HEIGHT;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.5));
                    };
                };
            });
        }

        // --- التعامل مع الرفع ---
        uploadBtn.addEventListener('click', () => {
            if (!state.isUploading) fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // حفظ الملف مؤقتاً وفتح نافذة العنوان
            state.pendingFile = file;
            openModal(titleModal);
        });

        // دالة المعالجة والرفع الفعلية
        async function processUpload(file, title, category) {
            state.isUploading = true;
            updateUploadUI();

            try {
                const compressedImage = await compressImage(file);
                const newPost = {
                    image: compressedImage,
                    title: title,
                    category: category,
                    likes: 0,
                    location: "من العراق", // تغيير الموقع الافتراضي
                    createdAt: Date.now(),
                    userId: state.user ? state.user.uid : 'offline-user',
                    isStatic: false
                };

                if (state.isConnected) {
                    try {
                        await addDoc(collection(db, 'gallery_posts'), newPost);
                    } catch (err) {
                        console.error("Firestore write failed:", err);
                        
                        let errorMsg = "فشل الرفع للسيرفر. تم الحفظ محلياً.";
                        
                        if (err.message.includes("does not exist") || err.code === 'not-found') {
                            errorMsg = "قاعدة البيانات غير موجودة. تم الحفظ محلياً.";
                            showError("قاعدة البيانات مفقودة! أنشئها الآن.", "https://console.firebase.google.com/project/neew-aec2b/firestore");
                        } else if (err.code === 'permission-denied') {
                             errorMsg = "لا توجد صلاحيات. تم الحفظ محلياً.";
                             showError("مشكلة في الصلاحيات (Rules).", "https://console.firebase.google.com/project/neew-aec2b/firestore/rules");
                        } else if (err.code === 'resource-exhausted' || err.message.includes("larger than")) {
                            errorMsg = "الصورة كبيرة جداً لقاعدة البيانات. تم الحفظ محلياً.";
                        }
                        
                        alert(errorMsg);
                        state.localPosts.unshift({...newPost, id: `local-${Date.now()}`});
                    }
                } else {
                    state.localPosts.unshift({...newPost, id: `local-${Date.now()}`});
                    alert("تم الحفظ محلياً (غير متصل)");
                }
                
                renderGallery();

            } catch (error) {
                console.error("Error processing image:", error);
                alert("حدث خطأ أثناء معالجة الصورة");
            } finally {
                state.isUploading = false;
                updateUploadUI();
            }
        }

        // --- الإعجابات ---
        window.handleLike = async (postId) => {
            if (String(postId).startsWith('local-')) return;
            if (!state.isConnected) return;
            
            try {
                const postRef = doc(db, 'gallery_posts', postId);
                await updateDoc(postRef, {
                    likes: increment(1)
                });
            } catch (e) {
                console.error("Like error:", e);
                if (e.code === 'permission-denied') {
                    showError("لا يمكن الإعجاب: لا توجد صلاحيات كتابة.", "https://console.firebase.google.com/project/neew-aec2b/firestore/rules");
                }
            }
        };

        // --- الحذف (للمشرف فقط) ---
        window.deletePost = async (postId) => {
            if (!confirm("هل أنت متأكد من حذف هذه الصورة نهائياً؟")) return;
            
            if (String(postId).startsWith('local-') || String(postId).startsWith('static-')) {
                 if(String(postId).startsWith('static-')) {
                     alert("لا يمكن حذف الصور الأساسية الثابتة.");
                     return;
                 }
                 state.localPosts = state.localPosts.filter(p => p.id !== postId);
                 renderGallery();
                 return;
            }

            try {
                await deleteDoc(doc(db, 'gallery_posts', postId));
            } catch (err) {
                console.error("Delete failed:", err);
                alert("فشل الحذف. تحقق من الصلاحيات.");
            }
        };

        // --- التعديل (للمشرف فقط) ---
        window.editPost = async (postId, currentTitle) => {
            if (String(postId).startsWith('static-')) {
                alert("لا يمكن تعديل الصور الأساسية.");
                return;
            }

            const newTitle = prompt("أدخل العنوان الجديد:", currentTitle);
            if (newTitle === null || newTitle === currentTitle) return;

            if (String(postId).startsWith('local-')) {
                const post = state.localPosts.find(p => p.id === postId);
                if (post) {
                    post.title = newTitle;
                    renderGallery();
                }
                return;
            }

            try {
                const postRef = doc(db, 'gallery_posts', postId);
                await updateDoc(postRef, {
                    title: newTitle
                });
            } catch (err) {
                console.error("Update failed:", err);
                alert("فشل التعديل. تحقق من الصلاحيات.");
            }
        };

        // --- عرض المعرض ---
        function renderGallery() {
            const allPosts = [...state.localPosts, ...state.dbPosts, ...initialPostsData];
            
            // تطبيق الفلتر والبحث
            const filteredPosts = allPosts.filter(post => {
                const matchesCategory = state.filter === 'الكل' || post.category === state.filter;
                // البحث في العنوان أو الموقع
                const searchLower = state.searchQuery.toLowerCase();
                const matchesSearch = post.title?.toLowerCase().includes(searchLower) || 
                                      post.location?.toLowerCase().includes(searchLower);
                
                return matchesCategory && matchesSearch;
            });

            galleryGrid.innerHTML = '';

            if (filteredPosts.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                
                filteredPosts.forEach(post => {
                    // أزرار التحكم للمشرف
                    let adminControls = '';
                    if (state.isAdmin) {
                        adminControls = `
                            <div class="absolute top-2 right-2 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity z-20">
                                <button onclick="editPost('${post.id}', '${post.title}')" class="admin-btn bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 shadow-lg" title="تعديل العنوان">
                                    <i data-lucide="pencil" class="w-4 h-4"></i>
                                </button>
                                <button onclick="deletePost('${post.id}')" class="admin-btn bg-red-500 text-white p-2 rounded-full hover:bg-red-600 shadow-lg" title="حذف الصورة">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        `;
                    }

                    const card = document.createElement('div');
                    card.className = 'glass-card rounded-2xl overflow-hidden masonry-item group hover:-translate-y-2 transition-transform duration-500 relative';
                    card.innerHTML = `
                        ${adminControls}
                        <div class="relative overflow-hidden">
                            <img 
                                src="${post.image}" 
                                alt="${post.title}" 
                                class="w-full h-auto object-cover transition-transform duration-700 group-hover:scale-110"
                                onerror="this.src='https://placehold.co/600x800/2a2a2a/FFF?text=Image+Error'"
                            >
                            <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-end p-4 pointer-events-none">
                                <p class="text-white text-sm font-medium translate-y-4 group-hover:translate-y-0 transition-transform duration-300">
                                    ${post.category}
                                </p>
                            </div>
                        </div>
                        <div class="p-5">
                            <div class="mb-3">
                                <h3 class="text-xl font-bold text-white mb-1">${post.title}</h3>
                                <div class="flex items-center text-gray-300 text-xs">
                                    <i data-lucide="map-pin" class="w-3 h-3 ml-1"></i>
                                    <span>${post.location}</span>
                                </div>
                            </div>
                            <div class="flex items-center justify-between pt-4 border-t border-white/10 mt-4">
                                <div class="flex gap-4">
                                    <button onclick="handleLike('${post.id}')" class="flex items-center gap-1 text-gray-200 hover:text-pink-400 transition-colors">
                                        <i data-lucide="heart" class="w-5 h-5"></i>
                                        <span class="text-sm font-medium">${post.likes}</span>
                                    </button>
                                </div>
                                <button onclick="handleShare('${post.title}', '${post.category}')" class="text-gray-200 hover:text-white transition-colors" title="مشاركة">
                                    <i data-lucide="share-2" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    galleryGrid.appendChild(card);
                });
            }
            lucide.createIcons();
        }

        // --- عرض الفلاتر ---
        const categories = ['الكل', 'كاليغرافي', 'بورتريه', 'خرائط', 'المجتمع'];
        function renderFilters() {
            filtersContainer.innerHTML = categories.map(cat => `
                <button 
                    onclick="setFilter('${cat}')"
                    class="px-6 py-2 rounded-full text-sm font-bold transition-all duration-300 backdrop-blur-md border ${
                        state.filter === cat 
                        ? 'bg-white/20 border-white/40 text-white shadow-[0_0_15px_rgba(255,255,255,0.3)]' 
                        : 'bg-white/5 border-white/10 text-gray-400 hover:bg-white/10 hover:text-white'
                    }"
                >
                    ${cat}
                </button>
            `).join('');
        }
        
        window.setFilter = (cat) => {
            state.filter = cat;
            renderFilters();
            renderGallery();
        };

        // --- تحديثات واجهة المستخدم ---
        function updateStatusUI() {
            // التحقق من حالة المشرف أولاً
            if (!state.isAdmin) {
                statusDiv.classList.add('hidden');
                statusDiv.classList.remove('md:flex');
                return;
            }

            // استعادة الظهور للمشرف (يظهر في الشاشات المتوسطة فما فوق)
            statusDiv.classList.add('md:flex'); 
            
            if (state.isConnected) {
                statusDiv.classList.replace('bg-amber-500/10', 'bg-green-500/10');
                statusDiv.classList.replace('border-amber-500/20', 'border-green-500/20');
                statusDiv.innerHTML = `
                    <div class="w-2 h-2 rounded-full bg-green-400 animate-pulse shadow-[0_0_8px_rgba(74,222,128,0.5)]"></div>
                    <span class="text-[10px] text-green-200 font-bold">متصل</span>
                `;
            } else {
                statusDiv.classList.replace('bg-green-500/10', 'bg-amber-500/10');
                statusDiv.classList.replace('border-green-500/20', 'border-amber-500/20');
                statusDiv.innerHTML = `
                    <i data-lucide="wifi-off" class="w-3 h-3 text-amber-400"></i>
                    <span class="text-[10px] text-amber-200 font-bold">غير متصل</span>
                `;
                lucide.createIcons();
            }
        }

        function updateUploadUI() {
            if (state.isUploading) {
                loadingIndicator.classList.remove('hidden');
                uploadBtn.classList.add('opacity-50', 'cursor-not-allowed');
                document.getElementById('upload-text').innerText = 'جاري الرفع...';
            } else {
                loadingIndicator.classList.add('hidden');
                uploadBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                document.getElementById('upload-text').innerText = 'نشر صورة';
            }
        }

        function showError(msg, link = null) {
            errorText.innerText = msg;
            errorBanner.classList.remove('hidden');
            
            if (link) {
                errorActionLink.href = link;
                errorActionLink.classList.remove('hidden');
            } else {
                errorActionLink.classList.add('hidden');
            }
            
            if (!msg.includes("قاعدة البيانات") && !msg.includes("صلاحيات")) {
                setTimeout(() => {
                    errorBanner.classList.add('hidden');
                }, 8000);
            }
        }

        // --- التشغيل الأولي ---
        initAuth();
        renderFilters();
        renderGallery();
        updateAdminUI(); 
        lucide.createIcons();

    </script>
</body>
</html>

import React, { useState, useEffect, useRef } from 'react';
import { Heart, Share2, MessageCircle, MapPin, Search, Menu, X, Image as ImageIcon, Plus, Upload, Loader, Wifi, WifiOff, AlertTriangle } from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, increment } from 'firebase/firestore';

// --- إعدادات Firebase الخاصة بك ---
const firebaseConfig = {
  apiKey: "AIzaSyD6MRZ7d7J1333erYoBrUGqocJNdGNjB7w",
  authDomain: "neew-aec2b.firebaseapp.com",
  databaseURL: "https://neew-aec2b-default-rtdb.firebaseio.com",
  projectId: "neew-aec2b",
  storageBucket: "neew-aec2b.firebasestorage.app",
  messagingSenderId: "70112873200",
  appId: "1:70112873200:web:b8ef2b3863be6f1bf39035"
};

// تهيئة التطبيق
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- البيانات الأولية (ثابتة) ---
const initialPostsData = [
  {
    id: 'static-1',
    image: "صورة واتساب بتاريخ 2025-12-04 في 23.43.18_81fa7aac.jpg",
    title: "فن الخط العربي - شهد",
    category: "كاليغرافي",
    likes: 124,
    location: "النجف الأشرف",
    isStatic: true
  },
  {
    id: 'static-2',
    image: "صورة واتساب بتاريخ 2025-12-04 في 23.43.19_8613f8c0.jpg",
    title: "جمالية الاسم - حسن",
    category: "كاليغرافي",
    likes: 98,
    location: "العراق",
    isStatic: true
  },
  {
    id: 'static-3',
    image: "صورة واتساب بتاريخ 2025-12-04 في 23.43.18_a97bb9ce.jpg",
    title: "مخطوطة علي",
    category: "كاليغرافي",
    likes: 215,
    location: "بغداد",
    isStatic: true
  },
  {
    id: 'static-4',
    image: "صورة واتساب بتاريخ 2025-12-04 في 23.43.19_a7e1a63b.jpg",
    title: "خريطة النجف الفنية",
    category: "خرائط",
    likes: 340,
    location: "النجف، حي الزهور",
    isStatic: true
  },
  {
    id: 'static-5',
    image: "صورة واتساب بتاريخ 2025-12-04 في 23.43.18_d3b410b6.jpg",
    title: "محمد (ص)",
    category: "كاليغرافي",
    likes: 450,
    location: "كربلاء",
    isStatic: true
  },
  {
    id: 'static-6',
    image: "صورة واتساب بتاريخ 2025-12-04 في 23.43.19_fbc44915.jpg",
    title: "الزهراء (ع)",
    category: "كاليغرافي",
    likes: 380,
    location: "النجف",
    isStatic: true
  },
  {
    id: 'static-7',
    image: "صورة واتساب بتاريخ 2025-12-04 في 23.43.18_b3e6f3bd.jpg",
    title: "مهدي (عج)",
    category: "كاليغرافي",
    likes: 290,
    location: "سامراء",
    isStatic: true
  },
  {
    id: 'static-8',
    image: "صورة واتساب بتاريخ 2025-12-04 في 23.43.19_d7e9624a.jpg",
    title: "بورتريه شخصية دينية",
    category: "بورتريه",
    likes: 150,
    location: "النجف",
    isStatic: true
  },
  {
    id: 'static-9',
    image: "صورة واتساب بتاريخ 2025-12-04 في 23.43.19_e231ffc8.jpg",
    title: "وقار العلماء",
    category: "بورتريه",
    likes: 185,
    location: "النجف",
    isStatic: true
  },
  {
    id: 'static-10',
    image: "صورة واتساب بتاريخ 2025-12-04 في 23.43.19_ba058cfc.jpg",
    title: "شخصية دينية",
    category: "بورتريه",
    likes: 130,
    location: "النجف",
    isStatic: true
  }
];

// --- مكونات واجهة المستخدم ---

const GlassCard = ({ children, className = "" }) => (
  <div className={`backdrop-blur-xl bg-white/10 border border-white/20 shadow-[0_8px_32px_0_rgba(31,38,135,0.37)] rounded-2xl ${className}`}>
    {children}
  </div>
);

const Post = ({ post, onLike }) => {
  const [isLiked, setIsLiked] = useState(false);
  const displayLikes = post.likes;

  const handleLike = () => {
    setIsLiked(!isLiked);
    onLike(post.id, !isLiked);
  };

  return (
    <GlassCard className="overflow-hidden group transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_15px_40px_0_rgba(31,38,135,0.45)] mb-8 break-inside-avoid">
      <div className="relative overflow-hidden aspect-auto">
        <img 
          src={post.image} 
          alt={post.title} 
          className="w-full h-auto object-cover transition-transform duration-700 group-hover:scale-110"
          onError={(e) => {
            e.target.onerror = null;
            e.target.src = "https://placehold.co/600x800/2a2a2a/FFF?text=Image+Error";
          }}
        />
        <div className="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-end p-4">
          <p className="text-white text-sm font-medium transform translate-y-4 group-hover:translate-y-0 transition-transform duration-300">
            {post.category}
          </p>
        </div>
      </div>

      <div className="p-5">
        <div className="flex justify-between items-start mb-3">
          <div>
            <h3 className="text-xl font-bold text-white mb-1 font-cairo">{post.title}</h3>
            <div className="flex items-center text-gray-300 text-xs">
              <MapPin size={12} className="ml-1" />
              <span>{post.location}</span>
            </div>
          </div>
        </div>

        <div className="flex items-center justify-between pt-4 border-t border-white/10 mt-4">
          <div className="flex space-x-4 space-x-reverse">
            <button 
              onClick={handleLike}
              className={`flex items-center space-x-1 space-x-reverse transition-colors duration-300 ${isLiked ? 'text-pink-500' : 'text-gray-200 hover:text-pink-400'}`}
            >
              <Heart size={20} fill={isLiked ? "currentColor" : "none"} />
              <span className="text-sm font-medium">{displayLikes + (isLiked && (post.isStatic || !post.userId) ? 1 : 0)}</span>
            </button>
            <button className="text-gray-200 hover:text-blue-400 transition-colors duration-300 flex items-center space-x-1 space-x-reverse">
              <MessageCircle size={20} />
              <span className="text-sm font-medium">تعليق</span>
            </button>
          </div>
          <button className="text-gray-200 hover:text-white transition-colors">
            <Share2 size={20} />
          </button>
        </div>
      </div>
    </GlassCard>
  );
};

const Navbar = ({ onUpload, isUploading, isConnected, authError }) => {
  const [isOpen, setIsOpen] = useState(false);
  const fileInputRef = useRef(null);

  const handleFileChange = (event) => {
    const file = event.target.files[0];
    if (file) {
      onUpload(file);
    }
  };

  return (
    <nav className="fixed top-0 left-0 right-0 z-50 px-4 py-4">
      <GlassCard className="max-w-7xl mx-auto px-6 py-3 flex justify-between items-center bg-white/10 rounded-full">
        {/* Logo & Status */}
        <div className="flex items-center gap-4">
            <div className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-300 via-purple-300 to-indigo-300 font-cairo">
            ألبوم فني
            </div>
            {/* مؤشر الاتصال */}
            {isConnected ? (
                <div className="hidden md:flex items-center gap-1 bg-green-500/10 border border-green-500/20 px-2 py-0.5 rounded-full">
                    <Wifi size={12} className="text-green-400" />
                    <span className="text-[10px] text-green-200 font-cairo font-bold">متصل</span>
                </div>
            ) : (
                 <div className="hidden md:flex items-center gap-1 bg-amber-500/10 border border-amber-500/20 px-2 py-0.5 rounded-full" title={authError || "وضع غير متصل"}>
                    <WifiOff size={12} className="text-amber-400" />
                    <span className="text-[10px] text-amber-200 font-cairo font-bold">تجريبي</span>
                </div>
            )}
        </div>

        {/* Desktop Menu */}
        <div className="hidden md:flex items-center space-x-8 space-x-reverse">
          {['الرئيسية', 'المعرض', 'فنانون', 'تواصل معنا'].map((item) => (
            <a key={item} href="#" className="text-gray-200 hover:text-white font-medium transition-colors font-cairo">
              {item}
            </a>
          ))}
        </div>

        {/* Actions */}
        <div className="hidden md:flex items-center space-x-4 space-x-reverse">
          <input 
            type="file" 
            ref={fileInputRef} 
            onChange={handleFileChange} 
            className="hidden" 
            accept="image/*"
          />
          <button 
            onClick={() => !isUploading && fileInputRef.current.click()}
            disabled={isUploading}
            className={`flex items-center space-x-2 space-x-reverse bg-pink-500/20 hover:bg-pink-500/40 text-pink-100 px-5 py-2 rounded-full text-sm font-bold transition-all border border-pink-500/30 font-cairo ${isUploading ? 'opacity-50 cursor-not-allowed' : ''}`}
          >
            {isUploading ? <Loader className="animate-spin" size={16} /> : <Plus size={16} />}
            <span>{isUploading ? 'جاري الرفع...' : 'إضافة عمل'}</span>
          </button>

          <div className="relative group">
            <input 
              type="text" 
              placeholder="بحث..." 
              className="bg-white/5 border border-white/10 rounded-full px-4 py-1.5 text-sm text-white focus:outline-none focus:bg-white/10 focus:border-white/30 transition-all w-32 group-hover:w-48 placeholder-gray-400 font-cairo"
            />
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4" />
          </div>
        </div>

        {/* Mobile Toggle */}
        <button className="md:hidden text-white" onClick={() => setIsOpen(!isOpen)}>
          {isOpen ? <X /> : <Menu />}
        </button>
      </GlassCard>

      {/* Mobile Menu */}
      {isOpen && (
        <GlassCard className="absolute top-20 left-4 right-4 p-4 flex flex-col space-y-4 md:hidden z-50">
           {['الرئيسية', 'المعرض', 'فنانون', 'تواصل معنا'].map((item) => (
            <a key={item} href="#" className="text-gray-100 font-medium py-2 border-b border-white/10 font-cairo">
              {item}
            </a>
          ))}
          <button 
             onClick={() => {
               if(!isUploading) {
                 fileInputRef.current.click();
                 setIsOpen(false);
               }
             }}
             disabled={isUploading}
             className="flex items-center justify-center space-x-2 space-x-reverse bg-pink-500/20 text-pink-100 py-2 rounded-xl border border-pink-500/30 font-cairo w-full"
          >
            <Upload size={16} />
            <span>{isUploading ? 'جاري الرفع...' : 'رفع صورة'}</span>
          </button>
        </GlassCard>
      )}
    </nav>
  );
};

// --- دالة مساعدة لضغط الصور ---
const compressImage = (file) => {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = (event) => {
      const img = new Image();
      img.src = event.target.result;
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const MAX_WIDTH = 800; // تقليل الأبعاد
        const MAX_HEIGHT = 800;
        let width = img.width;
        let height = img.height;

        if (width > height) {
          if (width > MAX_WIDTH) {
            height *= MAX_WIDTH / width;
            width = MAX_WIDTH;
          }
        } else {
          if (height > MAX_HEIGHT) {
            width *= MAX_HEIGHT / height;
            height = MAX_HEIGHT;
          }
        }

        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        // ضغط الجودة إلى 0.6 لتقليل الحجم
        const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
        resolve(dataUrl);
      };
    };
  });
};

export default function App() {
  const [user, setUser] = useState(null);
  const [dbPosts, setDbPosts] = useState([]);
  const [localPosts, setLocalPosts] = useState([]); // لحفظ الصور محلياً إذا فشل الاتصال
  const [filter, setFilter] = useState('الكل');
  const [isUploading, setIsUploading] = useState(false);
  const [authError, setAuthError] = useState(null);

  const isConnected = !!user && !authError;
  const categories = ['الكل', 'كاليغرافي', 'بورتريه', 'خرائط', 'المجتمع'];

  // 1. المصادقة (دخول مجهول) مع معالجة الأخطاء الذكية
  useEffect(() => {
    const initAuth = async () => {
      try {
        await signInAnonymously(auth);
        setAuthError(null);
      } catch (err) {
        console.error("Firebase Auth Error:", err);
        if (err.code === 'auth/admin-restricted-operation') {
            setAuthError("الرجاء تفعيل 'Anonymous' في Firebase Console > Authentication");
        } else {
            setAuthError("تعذر الاتصال بقاعدة البيانات. يعمل التطبيق في الوضع المحلي.");
        }
      }
    };
    initAuth();
    
    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
        if (currentUser) {
            setUser(currentUser);
            setAuthError(null);
        } else {
            setUser(null);
        }
    });
    return () => unsubscribe();
  }, []);

  // 2. جلب البيانات (الاستماع المباشر)
  useEffect(() => {
    if (!user) return;
    
    const postsRef = collection(db, 'gallery_posts');
    
    // محاولة الاتصال، إذا فشل الاذن سيعمل الصامت
    const unsubscribe = onSnapshot(postsRef, (snapshot) => {
      const fetchedPosts = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data(),
        isStatic: false
      }));
      fetchedPosts.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
      setDbPosts(fetchedPosts);
    }, (error) => {
      console.log("Firestore error (likely permission or auth):", error.code);
      // لا نعرض خطأ هنا لأننا سنعتمد على localPosts
    });

    return () => unsubscribe();
  }, [user]);

  // 3. دالة الرفع (الذكية: ترفع لـ Firebase إذا أمكن، وإلا محلياً)
  const handleUpload = async (file) => {
    setIsUploading(true);

    try {
      // ضغط الصورة
      const compressedImage = await compressImage(file);
      
      const newPost = {
        image: compressedImage,
        title: "مشاركة جديدة",
        category: "المجتمع",
        likes: 0,
        location: isConnected ? "من الويب" : "جهازي (محلي)",
        createdAt: Date.now(),
        userId: user ? user.uid : 'offline-user',
        isStatic: false
      };

      if (isConnected) {
          // محاولة الرفع للسيرفر
          try {
            const postsRef = collection(db, 'gallery_posts');
            await addDoc(postsRef, newPost);
          } catch (e) {
            console.error("Upload failed, falling back to local:", e);
            // إذا فشل الرفع للسيرفر، أضفها محلياً فقط
            setLocalPosts(prev => [{...newPost, id: `local-${Date.now()}`}, ...prev]);
            alert("فشل الرفع لقاعدة البيانات (تحقق من الإعدادات). تمت الإضافة للعرض المحلي فقط.");
          }
      } else {
          // الوضع المحلي مباشرة
          setLocalPosts(prev => [{...newPost, id: `local-${Date.now()}`}, ...prev]);
      }

    } catch (error) {
      console.error("Error processing image:", error);
      alert("حدث خطأ أثناء معالجة الصورة.");
    } finally {
      setIsUploading(false);
    }
  };

  // 4. دالة الإعجاب
  const handleLike = async (postId, incrementLike) => {
    if (String(postId).startsWith('local-')) return; // لا تفعل شيئاً للمحلي
    
    if (!isConnected) return;

    try {
        const postRef = doc(db, 'gallery_posts', postId);
        await updateDoc(postRef, {
            likes: increment(incrementLike ? 1 : -1)
        });
    } catch (e) {
        console.error("Error updating likes", e);
    }
  };

  // دمج كل المنشورات: المحلية أولاً، ثم السحابية، ثم الثابتة
  const allPosts = [...localPosts, ...dbPosts, ...initialPostsData];

  const filteredPosts = filter === 'الكل' 
    ? allPosts 
    : allPosts.filter(post => post.category === filter);

  return (
    <div className="min-h-screen relative font-cairo text-right" dir="rtl">
      {/* Background Elements */}
      <div className="fixed inset-0 bg-[#0f172a] -z-20"></div>
      
      {/* Animated Orbs */}
      <div className="fixed top-[-10%] left-[-10%] w-[40vw] h-[40vw] rounded-full bg-purple-600/30 blur-[100px] animate-pulse -z-10"></div>
      <div className="fixed bottom-[-10%] right-[-10%] w-[40vw] h-[40vw] rounded-full bg-blue-600/20 blur-[120px] animate-pulse -z-10" style={{animationDelay: '2s'}}></div>
      <div className="fixed top-[40%] left-[40%] w-[30vw] h-[30vw] rounded-full bg-pink-600/20 blur-[100px] animate-pulse -z-10" style={{animationDelay: '4s'}}></div>

      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap');
        .font-cairo { font-family: 'Cairo', sans-serif; }
      `}</style>

      <Navbar onUpload={handleUpload} isUploading={isUploading} isConnected={isConnected} authError={authError} />

      <main className="pt-32 pb-12 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto">
        
        {/* Error Banner (Shows only if there is an issue) */}
        {authError && (
            <div className="mb-8 bg-amber-500/20 border border-amber-500/50 text-amber-100 p-4 rounded-xl flex items-center justify-between backdrop-blur-md animate-in fade-in slide-in-from-top-4">
                <div className="flex items-center gap-3">
                    <AlertTriangle className="text-amber-400 shrink-0" />
                    <span className="text-sm font-bold">{authError}</span>
                </div>
                <span className="text-xs bg-amber-500/30 px-2 py-1 rounded shrink-0">وضع محلي</span>
            </div>
        )}

        {/* Header Section */}
        <div className="text-center mb-16 relative">
          <h1 className="text-5xl md:text-7xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-200 via-pink-200 to-white mb-6 drop-shadow-lg">
            مجتمع الفن
          </h1>
          <p className="text-xl text-gray-300 max-w-2xl mx-auto leading-relaxed">
            مساحة مشتركة لعرض إبداعات الخط العربي والبورتريه.
            شارك أعمالك ليراها العالم.
          </p>
          
          {/* Filters */}
          <div className="flex flex-wrap justify-center gap-3 mt-10">
            {categories.map((cat) => (
              <button
                key={cat}
                onClick={() => setFilter(cat)}
                className={`px-6 py-2 rounded-full text-sm font-bold transition-all duration-300 backdrop-blur-md border ${
                  filter === cat 
                    ? 'bg-white/20 border-white/40 text-white shadow-[0_0_15px_rgba(255,255,255,0.3)]' 
                    : 'bg-white/5 border-white/10 text-gray-400 hover:bg-white/10 hover:text-white'
                }`}
              >
                {cat}
              </button>
            ))}
          </div>
        </div>

        {/* Status Message */}
        {isUploading && (
           <div className="max-w-md mx-auto mb-8 bg-blue-500/20 border border-blue-500/50 rounded-xl p-4 flex items-center justify-center gap-3 text-blue-100 animate-pulse">
             <Loader className="animate-spin" />
             <span>جاري رفع تحفتك الفنية...</span>
           </div>
        )}

        {/* Masonry Grid Layout */}
        <div className="columns-1 md:columns-2 lg:columns-3 gap-8 space-y-8">
          {filteredPosts.map((post) => (
            <Post key={post.id} post={post} onLike={handleLike} />
          ))}
        </div>

        {filteredPosts.length === 0 && (
          <div className="text-center py-20 text-gray-400">
            <ImageIcon className="w-16 h-16 mx-auto mb-4 opacity-50" />
            <p className="text-xl">لا توجد منشورات في هذا التصنيف</p>
          </div>
        )}
      </main>

      <footer className="text-center py-8 text-gray-500 text-sm border-t border-white/5 relative z-10">
        <p>© 2025 معرض الفنون الرقمية. جميع الحقوق محفوظة.</p>
      </footer>
    </div>
  );
}
